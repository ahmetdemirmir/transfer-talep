<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Demir Kƒ±rtasiye ‚Äî ≈ûube Transfer Talep (Kamera Destekli)</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f7fa;text-align:center;padding:20px}
h1{color:#2c3e50;display:inline-block;margin-left:10px}
#header{display:flex;align-items:center;justify-content:center;gap:12px}
#logo{height:56px;object-fit:contain}

/* giri≈ü alanlarƒ± */
#fileInput,#manualBarcode,#quickSearch{margin:10px 0;padding:14px;font-size:18px;border-radius:12px;width:96%;max-width:380px}

/* kamera & kontroller */
#cameraControls{margin:18px 0 10px;display:flex;flex-wrap:wrap;justify-content:center;gap:8px}
#cameraControls button,#cameraControls input[type=file]{font-size:18px;padding:13px 18px;margin:0;border-radius:12px;border:1.5px solid #ccc;min-width:130px}
#scanBarcodeBtn{background:linear-gradient(90deg,#4CAF50,#77dd77);color:#fff;border:none}
#cameraSwitchBtn{background:linear-gradient(90deg,#1976D2,#65b1fc);color:#fff;border:none}
#saveJsonBtn,#loadJsonBtn{background:linear-gradient(90deg,#0097A7,#00BCD4);color:#fff;border:none}
#exportBtn{background:linear-gradient(90deg,#9c27b0,#ce93d8);color:#fff;border:none}
#resetBtn{background:linear-gradient(90deg,#e53935,#e57373);color:#fff;border:none}
#qr-reader{width:95vw;max-width:400px;margin:10px auto 20px;display:none;border-radius:18px;box-shadow:0 0 10px #bbb}

/* √ºr√ºn listesi */
#productList{margin-top:20px;text-align:left}
.item{display:flex;justify-content:space-between;padding:16px;margin:8px 0;border-bottom:1px solid #ddd;background:#3498db;color:#fff;font-size:18px;cursor:pointer;border-radius:10px}
#searchResults{margin-top:8px}
#searchResults .item{background:#1976D2;color:#fff;border-radius:7px;font-size:18px;cursor:pointer}
#searchResults .item:hover{background:#1565C0}

/* overlay/kart */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:999}
.card{background:#fff;color:#111;padding:26px;border-radius:18px;width:92vw;max-width:700px;text-align:left;position:relative}
.card h2{margin:0 0 10px}
.overlay-close{position:absolute;top:10px;right:12px;background:#7f8c8d;color:#fff;border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;font-weight:bold;font-size:21px}

/* stok tablosu */
#stockTitle{margin:8px 0 6px}
#stockTable{width:100%;border-collapse:separate;border-spacing:0;margin-top:6px}
#stockTable thead th{font-weight:700;color:#334155;border-bottom:2px solid #e5e7eb;padding:10px;text-align:left}
#stockTable tbody tr{cursor:pointer;box-shadow:inset 0 -1px #e5e7eb,inset 0 1px #e5e7eb}
#stockTable td{padding:14px 12px;text-align:left}
#stockTable td.branch-name{font-weight:800;font-size:17px}
#stockTable td.branch-qty{font-weight:800;font-size:20px} /* B√úY√úK ve KALIN */
#stockTable tbody tr:hover{filter:brightness(.98)}

/* kurumsal pastel ≈üeritler */
.branch-MERKEZ{background:#eaf4ff}
.branch-ATAEVLER{background:#f3e9ff}
.branch-TOPKAPI{background:#fff2e5}
.branch-FETHIYE{background:#eaf8ee}
.branch-FETHIYE_DEPO{background:#e8fbff}

/* form alanlarƒ± */
#transferForm{display:grid;grid-template-columns:1fr;gap:12px;align-items:center;margin-top:14px}
#transferForm label{font-size:13px;color:#475569;display:block;margin-bottom:4px}
#transferForm select{padding:10px 12px;border-radius:10px;border:1px solid #dcdcdc;font-size:16px;width:100%}

#transferActions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.btn-primary{background:linear-gradient(90deg,#43A047,#A5D6A7);color:#fff;border:none;padding:12px 18px;border-radius:12px;cursor:pointer}
.btn-secondary{background:linear-gradient(90deg,#607d8b,#a7b3c1);color:#fff;border:none;padding:12px 18px;border-radius:12px;cursor:pointer}

/* 2. popup ‚Äî b√ºy√ºt√ºlm√º≈ü y√∂n + 2√ó butonlar */
#qtyOverlay .card{max-width:640px}
#qtyTitle{margin-bottom:10px;font-size:26px}
.dir-top{display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0 14px}
.dir-top .supply{color:#0f172a;font-weight:900;font-size:24px}
.dir-top .demand{color:#dc2626;font-weight:900;font-size:24px} /* Talep Eden kƒ±rmƒ±zƒ± */
.dir-top .arrow-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:9999px;background:#0ea5e9;color:#fff;font-weight:900;font-size:20px;box-shadow:0 2px 0 #0284c7}

#quickQtyGrid{display:flex;flex-wrap:wrap;gap:12px;margin-top:0}
.quick-btn{flex:1 0 45%;min-width:140px;padding:18px;border:none;border-radius:14px;background:#0ea5e9;color:#fff;font-size:28px;font-weight:800;cursor:pointer}
.quick-btn.alt{background:#64748b}
.quick-btn.active{outline:4px solid #0f766e}
.quick-btn[disabled]{opacity:.35;cursor:not-allowed}

#manualQtyWrap{display:flex;gap:10px;margin-top:12px}
#manualQty{flex:1;padding:14px 14px;border:1px solid #dcdcdc;border-radius:12px;font-size:18px}
#saveQty{background:linear-gradient(90deg,#43A047,#A5D6A7);color:#fff;border:none;padding:14px 18px;border-radius:12px;cursor:pointer;font-size:18px}

/* sepet/inline liste */
#cartBar{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px}
#openCartBtn{background:linear-gradient(90deg,#8e24aa,#ba68c8);color:#fff;border:none;padding:12px 18px;border-radius:12px;cursor:pointer}
#cartCount{font-weight:bold}
#cartInline{max-width:900px;margin:14px auto;text-align:left}
#cartInline table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
#cartInline th,#cartInline td{border-bottom:1px solid #eee;padding:10px 12px}
#cartInline th{background:#f1f5f9;text-transform:uppercase;font-size:12px;letter-spacing:.02em}

/* Sepet overlay scroll */
#cartOverlay .card{max-height:88vh;overflow:hidden}
#cartTableWrap{max-height:60vh;overflow-y:auto}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div id="header">
    <img id="logo" src="logo.png" alt="Demir Kƒ±rtasiye Logosu" />
    <h1>Demir Kƒ±rtasiye ‚Äî ≈ûube Transfer Talep</h1>
  </div>

  <input type="file" id="fileInput" accept=".xlsx,.csv"><br>

  <!-- PC: Hƒ±zlƒ± Arama + Barkod elle (mobilde gizlenecek) -->
  <input type="text" id="quickSearch" placeholder="Hƒ±zlƒ± Arama (son 6 / isim) ‚Äî PC" autocomplete="off">
  <input type="text" id="manualBarcode" placeholder="Barkodu okutun veya yazƒ±p Enter" autocomplete="off">

  <div id="cameraControls">
    <button id="scanBarcodeBtn">üì∑ Kamera ile Okut</button>
    <button id="cameraSwitchBtn" style="display:none;">üîÑ Kamerayƒ± Deƒüi≈ütir</button>
    <button id="saveJsonBtn">üíæ Veriyi Kaydet (JSON)</button>
    <input type="file" id="loadJsonInput" style="display:none" accept=".json"/>
    <button id="loadJsonBtn">üìÇ Veriyi Y√ºkle (JSON)</button>
    <button id="exportBtn">üì• Transferi Excel‚Äôe Aktar</button>
    <button id="resetBtn">üîÑ Sƒ±fƒ±rla</button>
  </div>

  <div id="qr-reader"></div>

  <!-- Sepet + Inline Liste -->
  <div id="cartBar"><button id="openCartBtn">üõí Transfer Sepeti <span id="cartCount">(0)</span></button></div>
  <div id="cartInline"></div>

  <div id="productList"></div><div id="searchResults"></div>

  <!-- TRANSFER POP-UP (1) -->
  <div id="transferOverlay" class="overlay">
    <div id="transferContent" class="card">
      <button class="overlay-close" id="closeTransferBtn">√ó</button>
      <h2 id="trName">√úr√ºn Adƒ±</h2>
      <div id="trBarcode" style="color:#475569;margin-bottom:6px;">Barkod: -</div>

      <h3 id="stockTitle">≈ûube Stok Durumlarƒ±</h3>
      <table id="stockTable">
        <thead><tr><th>≈ûube</th><th>Stok</th></tr></thead>
        <tbody id="stockBody"></tbody>
      </table>

      <div id="transferForm">
        <div>
          <label for="sourceBranch">Talep Eden ≈ûube</label>
          <select id="sourceBranch"></select>
        </div>
      </div>

      <div id="transferActions">
        <button class="btn-secondary" id="btnCloseNoSave">Kapat</button>
      </div>
    </div>
  </div>

  <!-- HIZLI ADET POP-UP (2) -->
  <div id="qtyOverlay" class="overlay">
    <div class="card">
      <button class="overlay-close" id="closeQtyBtn">√ó</button>
      <h2 id="qtyTitle">Adet Se√ß</h2>

      <!-- Y√ñN ≈ûERƒ∞Dƒ∞ (√ºstte ve 2√ó b√ºy√ºk) -->
      <div class="dir-top" id="dirInfo"></div>

      <div id="quickQtyGrid">
        <button class="quick-btn" data-q="1">1</button>
        <button class="quick-btn" data-q="2">2</button>
        <button class="quick-btn" data-q="3">3</button>
        <button class="quick-btn" data-q="6">6</button>
        <button class="quick-btn" data-q="12">12</button>
        <button class="quick-btn alt" id="btnPlusManual">+</button>
      </div>

      <div id="manualQtyWrap">
        <input type="number" id="manualQty" min="1" placeholder="Manuel adet‚Ä¶">
        <button id="saveQty">Talebi Kaydet & Kameraya D√∂n</button>
      </div>
    </div>
  </div>

  <!-- SEPET POP-UP -->
  <div id="cartOverlay" class="overlay">
    <div id="cartContent" class="card">
      <button class="overlay-close" id="closeCartBtn">√ó</button>
      <h2>Transfer Sepeti</h2>
      <div id="cartTableWrap"></div>
      <div class="actions">
        <button class="btn-primary" id="btnExportCartXlsx">üì• Excel‚Äôe Aktar</button>
        <button class="btn-secondary" id="btnClearCart">üßπ Sepeti Temizle</button>
      </div>
    </div>
  </div>

  <!-- HATA POP-UP -->
  <div id="errorOverlay" class="overlay">
    <div class="card" style="background:#e74c3c;color:#fff;">
      <button class="overlay-close" id="closeErrorBtn">√ó</button>
      <h2>‚ùå Hata</h2>
      <p id="errorText">Bu i≈ülem yapƒ±lamaz.</p>
    </div>
  </div>

<script>
/* ====== Durum ====== */
let products=[]; 
let qrScanner=null, qrScannerActive=false, currentFacingMode="environment";
const STORAGE_KEY_PRODUCTS="demir_transfer_products";
const STORAGE_KEY_CART="demir_transfer_cart";
const STORAGE_KEY_LAST_FROM="demir_transfer_last_from";

let transferCart=[];
let currentProduct=null;
let pendingTargetBranch=null;     // tedarik ≈üubesi (stok veren)
let supplyMaxQty=0;               // tedarik ≈üubesindeki stok
let selectedQty=null;

/* ====== Elemanlar ====== */
const isMobile=/Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
const fileInput=document.getElementById('fileInput');
const manualBarcode=document.getElementById('manualBarcode');
const quickSearch=document.getElementById('quickSearch');
const qrReaderDiv=document.getElementById('qr-reader');
const scanBarcodeBtn=document.getElementById('scanBarcodeBtn');
const cameraSwitchBtn=document.getElementById('cameraSwitchBtn');

const productList=document.getElementById('productList');
const searchResults=document.getElementById('searchResults');

const transferOverlay=document.getElementById('transferOverlay');
const transferContent=document.getElementById('transferContent');
const closeTransferBtn=document.getElementById('closeTransferBtn');
const btnCloseNoSave=document.getElementById('btnCloseNoSave');
const trName=document.getElementById('trName');
const trBarcode=document.getElementById('trBarcode');
const stockBody=document.getElementById('stockBody');
const sourceBranchSel=document.getElementById('sourceBranch');

const qtyOverlay=document.getElementById('qtyOverlay');
const closeQtyBtn=document.getElementById('closeQtyBtn');
const qtyTitle=document.getElementById('qtyTitle');
const dirInfo=document.getElementById('dirInfo');
const manualQty=document.getElementById('manualQty');
const saveQty=document.getElementById('saveQty');
const quickQtyGrid=document.getElementById('quickQtyGrid');

const openCartBtn=document.getElementById('openCartBtn');
const cartCount=document.getElementById('cartCount');
const cartInline=document.getElementById('cartInline');
const cartOverlay=document.getElementById('cartOverlay');
const closeCartBtn=document.getElementById('closeCartBtn');
const cartTableWrap=document.getElementById('cartTableWrap');

const exportBtn=document.getElementById('exportBtn');
const btnExportCartXlsx=document.getElementById('btnExportCartXlsx');
const btnClearCart=document.getElementById('btnClearCart');

const errorOverlay=document.getElementById('errorOverlay');
const closeErrorBtn=document.getElementById('closeErrorBtn');
const errorText=document.getElementById('errorText');

/* ====== Genel yardƒ±mcƒ±lar ====== */
function closeAllPopups(){
  transferOverlay.style.display='none';
  qtyOverlay.style.display='none';
  errorOverlay.style.display='none';
  cartOverlay.style.display='none';
}
function persistAll(){ localStorage.setItem(STORAGE_KEY_PRODUCTS,JSON.stringify(products)); localStorage.setItem(STORAGE_KEY_CART,JSON.stringify(transferCart)); }
function renderCartCount(){ cartCount.textContent=`(${transferCart.length})`; }
function renderCartInline(){
  if(!transferCart.length){ cartInline.innerHTML=""; return; }
  const rows=transferCart.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r["Talep Y√∂n√º"]}</td><td>${r["Barkod"]}</td><td>${r["√úr√ºn Adƒ±"]}</td>
    <td style="text-align:right">${r["Talep Adedi"]}</td>
  </tr>`).join('');
  cartInline.innerHTML=`<h3 style="margin:8px 0 6px;text-align:left">Talep Listesi</h3>
  <table><thead><tr><th>#</th><th>Ta≈üƒ±ma Y√∂n√º</th><th>Barkod</th><th>√úr√ºn</th><th>Adet</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function showError(msg){ errorText.textContent=msg||"Hata"; errorOverlay.style.display='flex'; }
function resumeAfterClose(){ if(isMobile){ if(qrScannerActive){ startQrScanner(); } } else { try{ manualBarcode.focus(); }catch{} }}

/* ====== Kamera ====== */
scanBarcodeBtn.addEventListener('click',()=>{ 
  if(!qrScannerActive){ qrReaderDiv.style.display='block'; startQrScanner(); scanBarcodeBtn.textContent='Kamerayƒ± Kapat'; }
  else { stopQrScanner(); qrReaderDiv.style.display='none'; scanBarcodeBtn.textContent='üì∑ Kamera ile Okut'; }
});
cameraSwitchBtn.addEventListener('click',()=>{ currentFacingMode=(currentFacingMode==="environment")?"user":"environment"; if(qrScannerActive){ stopQrScanner(true); startQrScanner(); }});
function startQrScanner(){
  qrScannerActive=true;
  qrScanner=new Html5Qrcode("qr-reader");
  qrScanner.start({facingMode:currentFacingMode},{fps:15,qrbox:250},code=>handleLookup(code,true),()=>{}).catch(()=>{});
}
function stopQrScanner(keepVisible=false){
  if(!qrScanner) return;
  qrScanner.stop().then(()=>{ qrScannerActive=false; if(!keepVisible){ qrReaderDiv.style.display='none'; } }).catch(()=>{});
}

/* ====== Excel/JSON ====== */
document.getElementById('saveJsonBtn').addEventListener('click',()=>{
  const dataStr=JSON.stringify({products,transferCart},null,2);
  const blob=new Blob([dataStr],{type:"application/json"}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='transfer_durum.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('loadJsonBtn').addEventListener('click',()=>document.getElementById('loadJsonInput').click());
document.getElementById('loadJsonInput').addEventListener('change',evt=>{
  const file=evt.target.files[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=e=>{ try{ const obj=JSON.parse(e.target.result); products=obj.products||[]; transferCart=obj.transferCart||[]; persistAll(); renderProducts(); renderCartCount(); renderCartInline(); alert("JSON y√ºklendi."); }catch{ alert("Ge√ßersiz JSON."); } };
  reader.readAsText(file);
});
fileInput.addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{defval:""});
    products=rows.map(r=>{const out={...r}; const raw=out.Barkodu; out.Barkodu=(raw==null)?"":String(typeof raw==='number'?Math.trunc(raw):raw).trim(); return out;});
    persistAll(); renderProducts();
  };
  reader.readAsArrayBuffer(file);
});

/* ====== Arama (PC) ====== */
if(isMobile){ quickSearch.style.display='none'; manualBarcode.style.display='none'; }
manualBarcode.addEventListener('keypress',e=>{ if(e.key==='Enter'){ const code=manualBarcode.value.trim(); manualBarcode.value=''; if(code) handleLookup(code,false); }});
quickSearch.addEventListener('input',()=>{
  const v=quickSearch.value.trim().toLowerCase(); if(!v||!products.length){searchResults.innerHTML='';return;}
  const results=products.filter(p=>{const b=String(p.Barkodu||'').toLowerCase(); const n=String(p["Stok Adƒ±"]||'').toLowerCase(); return b.includes(v)||b.slice(-6).includes(v)||n.includes(v);});
  if(results.length===1 && v.length>2){ openTransferPopup(results[0]); searchResults.innerHTML=''; return; }
  searchResults.innerHTML=results.slice(0,8).map(p=>`<div class="item" onclick="window._openByIdx(${products.indexOf(p)})"><b>${p.Barkodu}</b> - ${p["Stok Adƒ±"]}</div>`).join('');
});
window._openByIdx=idx=>{const p=products[idx]; if(p){ openTransferPopup(p); quickSearch.value=''; searchResults.innerHTML=''; }};

/* ====== Lookup ====== */
function handleLookup(val,fromCamera){
  const s=String(val).trim();
  let found=products.find(p=>p.Barkodu===s || String(p.Barkodu).slice(-6)===s);
  if(!found){ found=products.find(p=> String(p["Stok Adƒ±"]).toLowerCase().includes(s.toLowerCase())); }
  if(!found){ showError("Bu √ºr√ºn listede yok."); if(fromCamera&&qrScannerActive){ stopQrScanner(true);} return; }
  openTransferPopup(found);
}

/* ====== Transfer Pop-up (1) ====== */
function openTransferPopup(p){
  currentProduct=p;
  trName.textContent=String(p["Stok Adƒ±"]||"√úr√ºn");
  trBarcode.textContent="Barkod: "+(p.Barkodu||"-");

  const stocks=getBranchStocks(p);
  stockBody.innerHTML = stocks.map(s=>`<tr class="${classForBranch(s.branch)}" data-branch="${s.branch}" data-qty="${s.qty}">
      <td class="branch-name">${displayNameForBranch(s.branch)}</td>
      <td class="branch-qty">${s.qty||0}</td>
    </tr>`).join('');

  // Talep Eden ≈üube se√ßenekleri
  sourceBranchSel.innerHTML='';
  stocks.forEach(s=>{ const o=document.createElement('option'); o.value=s.branch; o.textContent=displayNameForBranch(s.branch); sourceBranchSel.appendChild(o); });
  const lastFrom=localStorage.getItem(STORAGE_KEY_LAST_FROM);
  if(lastFrom && [...sourceBranchSel.options].some(o=>o.value===lastFrom)) sourceBranchSel.value=lastFrom;

  // Satƒ±r tƒ±klama ‚Üí kontroller ve 2. popup
  stockBody.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('click',()=>{
      const from=sourceBranchSel.value;
      const target=tr.getAttribute('data-branch');
      if(from===target){ showError("Aynƒ± ≈üubeden aynƒ± ≈üubeye talep yapƒ±lamaz."); return; }
      const qtyNum=parseFloat(String(tr.getAttribute('data-qty')).replace(',','.'))||0;
      if(qtyNum<=0){ showError("Stok 0 ‚Äî bu ≈üubeden talep edilemez."); return; }
      pendingTargetBranch=target; supplyMaxQty=qtyNum;
      openQtyPopup(displayNameForBranch(target), supplyMaxQty);
    });
  });

  transferOverlay.style.display='flex';
}

/* ====== Hƒ±zlƒ± Adet Pop-up (2) ====== */
function openQtyPopup(targetLabel, maxQty){
  const fromLbl=displayNameForBranch(sourceBranchSel.value);
  dirInfo.innerHTML=`<span class="supply">${targetLabel}</span><span class="arrow-badge">üöö ‚ûú</span><span class="demand">${fromLbl}</span>`;
  selectedQty=null; manualQty.value=''; manualQty.max=String(maxQty); manualQty.placeholder=`Manuel adet‚Ä¶ (max ${maxQty})`;
  // hƒ±zlƒ± butonlar ‚Äî stok √ºst√ºn√º kilitle
  [...quickQtyGrid.querySelectorAll('.quick-btn')].forEach(btn=>{
    const q=btn.getAttribute('data-q');
    btn.classList.remove('active');
    if(q){ btn.disabled=parseInt(q,10)>maxQty; } else { btn.disabled=false; }
  });
  qtyOverlay.style.display='flex';
}
/* hƒ±zlƒ± buton se√ßimi */
quickQtyGrid.addEventListener('click',e=>{
  const btn=e.target.closest('.quick-btn'); if(!btn||btn.disabled) return;
  const q=btn.getAttribute('data-q');
  [...quickQtyGrid.querySelectorAll('.quick-btn')].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(q){ selectedQty=parseInt(q,10); manualQty.value=selectedQty; } else { manualQty.focus(); }
});

/* ====== Kayƒ±t & sonrasƒ± ====== */
saveQty.addEventListener('click',(e)=>{
  e.preventDefault(); // her ihtimale kar≈üƒ±
  let q = (selectedQty!=null)?selectedQty:parseInt(manualQty.value||'0',10);
  if(isNaN(q)||q<1){ showError("Ge√ßerli bir adet girin."); return; }
  if(q>Number(supplyMaxQty)){ showError(`Maksimum ${supplyMaxQty} adet talep edebilirsiniz.`); return; }
  try{
    finalizeAdd(q);
  } finally {
    closeAllPopups();     // üëà Kaydet anƒ±nda kesin kapat
    resumeAfterClose();   // kameraya/barkoda d√∂n√º≈ü
  }
});
manualQty.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); saveQty.click(); } });

function finalizeAdd(qty){
  if(!currentProduct || !pendingTargetBranch) return;
  const from=sourceBranchSel.value;
  localStorage.setItem(STORAGE_KEY_LAST_FROM,from);

  transferCart.push({
    "Talep Eden ≈ûube":displayNameForBranch(from),
    "Talep Edilen ≈ûube":displayNameForBranch(pendingTargetBranch),
    "Talep Y√∂n√º":`${displayNameForBranch(pendingTargetBranch)} ‚ûú ${displayNameForBranch(from)}`,
    "Barkod":String(currentProduct.Barkodu||''),
    "√úr√ºn Adƒ±":String(currentProduct["Stok Adƒ±"]||''),
    "Talep Adedi":qty
  });
  persistAll(); renderCartCount(); renderCartInline();
}

/* ====== Sepet ====== */
openCartBtn.addEventListener('click',()=>openCart());
closeCartBtn.addEventListener('click',()=>{ cartOverlay.style.display='none'; });
function openCart(){ cartTableWrap.innerHTML=buildCartTableHTML(); cartOverlay.style.display='flex'; }
function buildCartTableHTML(){
  if(!transferCart.length) return "<p>Sepet bo≈ü.</p>";
  const rows=transferCart.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r["Talep Y√∂n√º"]}</td><td>${r["Barkod"]}</td><td>${r["√úr√ºn Adƒ±"]}</td>
    <td style="text-align:right">${r["Talep Adedi"]}</td>
    <td><button data-idx="${i}" class="btn-secondary btn-del">Sil</button></td>
  </tr>`).join('');
  return `<table style="width:100%;border-collapse:collapse">
    <thead><tr><th>#</th><th>Ta≈üƒ±ma Y√∂n√º</th><th>Barkod</th><th>√úr√ºn</th><th>Adet</th><th></th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}
cartTableWrap.addEventListener('click',e=>{
  const btn=e.target.closest('.btn-del'); if(!btn) return;
  const idx=parseInt(btn.getAttribute('data-idx'),10);
  if(!isNaN(idx)){ transferCart.splice(idx,1); persistAll(); cartTableWrap.innerHTML=buildCartTableHTML(); renderCartCount(); renderCartInline(); }
});
btnExportCartXlsx.addEventListener('click',exportCartXlsx);
exportBtn.addEventListener('click',exportCartXlsx);
function exportCartXlsx(){
  if(!transferCart.length){ alert("Sepet bo≈ü."); return; }
  const ws=XLSX.utils.json_to_sheet(transferCart);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Transfer Talepleri");
  XLSX.writeFile(wb,"transfer_talepleri.xlsx");
}
btnClearCart.addEventListener('click',()=>{ 
  if(!transferCart.length) return;
  if(confirm("Sepeti temizle?")){
    transferCart=[]; persistAll(); 
    renderCartCount(); renderCartInline();
    cartTableWrap.innerHTML=buildCartTableHTML(); // overlay a√ßƒ±ksa da anƒ±nda bo≈üalt
  }
});

/* ====== Overlay kapatma: arka plan ve ESC ====== */
[transferOverlay, qtyOverlay, errorOverlay, cartOverlay].forEach(ov=>{
  ov.addEventListener('click',e=>{ if(e.target===ov) closeAllPopups(); });
});
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeAllPopups(); });
closeTransferBtn.addEventListener('click',closeAllPopups);
btnCloseNoSave.addEventListener('click',closeAllPopups);
closeQtyBtn.addEventListener('click',closeAllPopups);
closeErrorBtn.addEventListener('click',()=>errorOverlay.style.display='none');

/* ====== Util ====== */
const BRANCH_COLS=["MERKEZ","ATAEVLER","TOPKAPI","FETHIYE","FETHIYE DEPO"];
function classForBranch(k){ return 'branch-'+String(k).trim().toUpperCase().replaceAll(' ','_');}
function displayNameForBranch(k){
  const K=String(k).trim().toUpperCase();
  if(K==="MERKEZ") return "Merkez";
  if(K==="ATAEVLER") return "Ataevler";
  if(K==="TOPKAPI") return "Topkapƒ±";
  if(K==="FETHIYE") return "Fethiye ≈ûube";
  if(K==="FETHIYE DEPO") return "Fethiye Depo";
  return k;
}
function getBranchStocks(p){
  const out=[]; Object.keys(p).forEach(k=>{ if(BRANCH_COLS.includes(String(k).trim().toUpperCase())){ out.push({branch:k,qty:(p[k]===''||p[k]==null)?0:p[k]}); }});
  return out;
}

/* ====== Init ====== */
(function init(){
  try{ const p=JSON.parse(localStorage.getItem(STORAGE_KEY_PRODUCTS)||"[]"); const c=JSON.parse(localStorage.getItem(STORAGE_KEY_CART)||"[]"); products=Array.isArray(p)?p:[]; transferCart=Array.isArray(c)?c:[]; }catch{}
  renderProducts(); renderCartCount(); renderCartInline();
})();

/* ====== √úr√ºn listeleme ====== */
function renderProducts(list=null){
  const data=list||products; productList.innerHTML='';
  data.forEach(p=>{
    const barkod=String(p.Barkodu||'').trim(); const name=String(p["Stok Adƒ±"]||'').trim();
    const div=document.createElement('div'); div.className='item'; 
    div.innerHTML=`<span><b>${barkod||'-'}</b> - ${name||''}</span><span></span>`;
    div.addEventListener('click',()=>openTransferPopup(p));
    productList.appendChild(div);
  });
}
</script>
</body>
</html>
